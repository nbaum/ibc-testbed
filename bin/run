#! /bin/env bash
set -euo pipefail
IFS=$'\n\t'

cd ${BASH_SOURCE%/*}/..

PATH=$PWD/bin:$PWD/lib:$PATH
chmod +x bin/* lib/*

supervisorctl shutdown || true

rm -rf var

mkdir -p var/log var/run

supervisord

(
  init-chain 0
  start-chain 0
) &

(
  init-chain 1
  start-chain 1
) &

wait

init-relayer 0 1

start-relayer

source include/env.sh

ibc-setup ics20

(
  use-chain 0
  ibc-transfer transfer channel-0 cudos1yvtuaadhfhxf8ke7zm902z4rj382a8ayymq32s 1$MCUDOS
) &

(
  use-chain 1
  ibc-transfer transfer channel-0 cudos1yvtuaadhfhxf8ke7zm902z4rj382a8ayymq32s 1$MCUDOS
)

use-chain 0
wasm-store cw20_base  share/wasm/cw20_base.wasm
wasm-store cw20_ics20 share/wasm/cw20_ics20.wasm

cw20-create PISS "Piss Coin" 18 1000

ics20-create VIZZINI

ibc-setup ics20 --src-port wasm.$(cat $CUDOS_HOME/instances/VIZZINI)
